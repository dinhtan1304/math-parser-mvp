<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Math Exam Parser</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
      :root {
        --bg: #f5f5f3;
        --surface: #ffffff;
        --sidebar-bg: #0f172a;
        --sidebar-hover: rgba(255, 255, 255, 0.06);
        --sidebar-active: rgba(99, 102, 241, 0.2);
        --primary: #4f46e5;
        --primary-light: #eef2ff;
        --primary-dark: #3730a3;
        --accent: #f59e0b;
        --accent-light: #fffbeb;
        --text: #1e1b4b;
        --text-secondary: #6b7280;
        --text-muted: #9ca3af;
        --border: #e5e7eb;
        --border-light: #f3f4f6;
        --success: #16a34a;
        --success-bg: #f0fdf4;
        --error: #dc2626;
        --error-bg: #fef2f2;
        --warning: #ea580c;
        --warning-bg: #fff7ed;
        --radius: 14px;
        --radius-sm: 8px;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 24px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.08);
        --font: "Plus Jakarta Sans", -apple-system, sans-serif;
        --mono: "JetBrains Mono", monospace;
        --sidebar-width: 300px;
        --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font);
        background: var(--bg);
        min-height: 100vh;
        display: flex;
        color: var(--text);
      }

      /* ==================== SIDEBAR ==================== */
      .sidebar {
        width: var(--sidebar-width);
        background: var(--sidebar-bg);
        display: flex;
        flex-direction: column;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        z-index: 100;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .sidebar-header {
        padding: 24px 20px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .sidebar-brand {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
      }

      .brand-icon {
        width: 38px;
        height: 38px;
        background: var(--primary);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: white;
        font-weight: 700;
        font-family: var(--mono);
      }

      .brand-name {
        color: white;
        font-size: 1.05rem;
        font-weight: 700;
        letter-spacing: -0.02em;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.8rem;
      }

      .user-name {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.88rem;
        font-weight: 500;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .sidebar-section-label {
        padding: 16px 20px 8px;
        font-size: 0.7rem;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.3);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .history-list {
        flex: 1;
        overflow-y: auto;
        padding: 4px 12px;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
      }

      .history-list::-webkit-scrollbar {
        width: 4px;
      }
      .history-list::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
      }

      .history-item {
        padding: 12px 14px;
        border-radius: 10px;
        cursor: pointer;
        transition: background var(--transition);
        margin-bottom: 2px;
      }

      .history-item:hover {
        background: var(--sidebar-hover);
      }
      .history-item.active {
        background: var(--sidebar-active);
      }

      .history-item-name {
        color: rgba(255, 255, 255, 0.85);
        font-size: 0.85rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 4px;
      }

      .history-item-meta {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .history-item-date {
        color: rgba(255, 255, 255, 0.35);
        font-size: 0.75rem;
      }

      .status-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      .status-dot.completed {
        background: #22c55e;
      }
      .status-dot.pending,
      .status-dot.processing {
        background: #f59e0b;
      }
      .status-dot.failed {
        background: #ef4444;
      }

      .history-empty {
        padding: 30px 20px;
        text-align: center;
        color: rgba(255, 255, 255, 0.25);
        font-size: 0.85rem;
      }

      .sidebar-footer {
        padding: 16px 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }

      .logout-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px;
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.85rem;
        font-weight: 500;
        font-family: var(--font);
        cursor: pointer;
        transition: all var(--transition);
      }

      .logout-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
      }

      /* ==================== MAIN ==================== */
      .main {
        flex: 1;
        margin-left: var(--sidebar-width);
        min-height: 100vh;
      }

      .main-header {
        padding: 0 40px;
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        z-index: 50;
      }

      .main-body {
        padding: 32px 40px;
        max-width: 960px;
      }

      /* ==================== TABS ==================== */
      .tabs {
        display: flex;
        gap: 0;
        padding-top: 16px;
      }

      .tab-btn {
        padding: 12px 24px;
        border: none;
        background: none;
        font-family: var(--font);
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-muted);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .tab-btn:hover {
        color: var(--text-secondary);
      }

      .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }

      .tab-btn .tab-count {
        background: var(--border-light);
        color: var(--text-muted);
        font-size: 0.72rem;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 10px;
        min-width: 24px;
        text-align: center;
      }

      .tab-btn.active .tab-count {
        background: var(--primary-light);
        color: var(--primary);
      }

      .tab-panel {
        display: none;
      }
      .tab-panel.active {
        display: block;
        animation: fadeUp 0.3s ease;
      }

      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ==================== UPLOAD (tab 1) ==================== */
      .upload-card {
        background: var(--surface);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        margin-bottom: 24px;
        overflow: hidden;
      }

      .upload-dropzone {
        padding: 48px 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.25s ease;
        border-bottom: 1px solid var(--border-light);
      }

      .upload-dropzone:hover {
        background: #fafaf8;
      }
      .upload-dropzone.dragover {
        background: var(--primary-light);
      }
      .upload-dropzone.has-file {
        padding: 24px 40px;
      }

      .dropzone-icon {
        width: 64px;
        height: 64px;
        background: var(--primary-light);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        transition: all 0.25s ease;
      }

      .dropzone-icon svg {
        width: 28px;
        height: 28px;
        color: var(--primary);
      }
      .upload-dropzone:hover .dropzone-icon {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(79, 70, 229, 0.15);
      }
      .dropzone-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 6px;
      }
      .dropzone-title span {
        color: var(--primary);
      }
      .dropzone-subtitle {
        color: var(--text-muted);
        font-size: 0.85rem;
      }

      .file-preview {
        display: none;
        align-items: center;
        gap: 14px;
      }
      .file-preview.visible {
        display: flex;
      }

      .file-thumb {
        width: 44px;
        height: 44px;
        background: var(--primary-light);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
      }

      .file-info {
        flex: 1;
        text-align: left;
        min-width: 0;
      }
      .file-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .file-size {
        color: var(--text-muted);
        font-size: 0.8rem;
      }

      .file-remove {
        width: 32px;
        height: 32px;
        border: none;
        background: none;
        color: var(--text-muted);
        cursor: pointer;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all var(--transition);
        flex-shrink: 0;
      }

      .file-remove:hover {
        background: var(--error-bg);
        color: var(--error);
      }

      .upload-controls {
        padding: 16px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
      }

      .vision-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        user-select: none;
      }
      .vision-toggle input {
        display: none;
      }

      .toggle-track {
        width: 40px;
        height: 22px;
        background: #d1d5db;
        border-radius: 11px;
        position: relative;
        transition: background var(--transition);
        flex-shrink: 0;
      }

      .toggle-track::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        top: 3px;
        left: 3px;
        transition: transform var(--transition);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
      }

      .vision-toggle input:checked + .toggle-track {
        background: var(--primary);
      }
      .vision-toggle input:checked + .toggle-track::after {
        transform: translateX(18px);
      }
      .toggle-text {
        font-size: 0.85rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .btn-parse {
        padding: 10px 28px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 0.9rem;
        font-weight: 600;
        font-family: var(--font);
        cursor: pointer;
        transition: all var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-parse:hover:not(:disabled) {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      }
      .btn-parse:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none;
      }

      .btn-parse .spinner {
        display: none;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
      }

      .btn-parse.loading .parse-text {
        display: none;
      }
      .btn-parse.loading .spinner {
        display: inline-block;
      }
      .btn-parse.loading {
        pointer-events: none;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      #fileInput {
        display: none;
      }

      /* ==================== PROGRESS ==================== */
      .progress-card {
        display: none;
        background: var(--surface);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        padding: 28px 32px;
        margin-bottom: 24px;
      }

      .progress-card.visible {
        display: block;
        animation: fadeUp 0.3s ease;
      }

      .progress-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .pulse-dot {
        width: 8px;
        height: 8px;
        background: var(--primary);
        border-radius: 50%;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(0.8);
        }
      }

      .progress-bar {
        height: 6px;
        background: var(--border-light);
        border-radius: 3px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), #818cf8);
        border-radius: 3px;
        transition: width 0.5s ease;
        width: 0%;
        position: relative;
      }

      .progress-fill::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: shimmer 1.5s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      /* ==================== RESULTS (parse output) ==================== */
      .results-card {
        display: none;
        background: var(--surface);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        overflow: hidden;
      }

      .results-card.visible {
        display: block;
        animation: fadeUp 0.4s ease;
      }

      .results-toolbar {
        padding: 18px 28px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--border-light);
        flex-wrap: wrap;
        gap: 12px;
      }

      .results-count {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--text);
      }
      .results-count span {
        color: var(--primary);
      }

      .toolbar-actions {
        display: flex;
        gap: 8px;
      }

      .btn-toolbar {
        padding: 8px 16px;
        border-radius: var(--radius-sm);
        font-size: 0.82rem;
        font-weight: 600;
        font-family: var(--font);
        cursor: pointer;
        transition: all var(--transition);
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .btn-toolbar:hover {
        background: var(--bg);
        border-color: #d1d5db;
      }
      .btn-toolbar.primary {
        background: var(--success);
        color: white;
        border-color: var(--success);
      }
      .btn-toolbar.primary:hover {
        background: #15803d;
      }

      .questions-list {
        padding: 8px 16px 16px;
      }

      /* ==================== SHARED Q-CARD (used in both tabs) ==================== */
      .q-card {
        padding: 24px;
        border: 1px solid var(--border-light);
        border-radius: 12px;
        margin-top: 12px;
        transition:
          border-color var(--transition),
          box-shadow var(--transition);
      }

      .q-card:hover {
        border-color: #d1d5db;
        box-shadow: var(--shadow-sm);
      }

      .q-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 14px;
        gap: 8px;
        flex-wrap: wrap;
      }

      .q-num {
        font-size: 0.82rem;
        font-weight: 700;
        color: var(--primary);
        background: var(--primary-light);
        padding: 4px 12px;
        border-radius: 6px;
      }

      .q-badges {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      .q-badge {
        padding: 3px 10px;
        border-radius: 6px;
        font-size: 0.72rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        text-transform: uppercase;
      }

      .q-badge.type {
        background: #eff6ff;
        color: #2563eb;
      }
      .q-badge.topic {
        background: #faf5ff;
        color: #7c3aed;
      }
      .q-badge.diff {
        background: var(--accent-light);
        color: #d97706;
      }

      .q-text {
        font-size: 0.95rem;
        line-height: 1.85;
        color: #374151;
        margin-bottom: 4px;
      }

      .q-answer {
        margin-top: 14px;
        padding: 14px 16px;
        background: var(--success-bg);
        border-radius: 10px;
        border-left: 3px solid var(--success);
      }

      .q-answer-label {
        font-size: 0.78rem;
        font-weight: 700;
        color: var(--success);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        margin-bottom: 4px;
      }
      .q-answer-text {
        color: #166534;
        font-size: 0.9rem;
        line-height: 1.6;
      }

      .q-solution {
        margin-top: 10px;
        padding: 14px 16px;
        background: var(--accent-light);
        border-radius: 10px;
        border-left: 3px solid var(--accent);
      }

      .q-solution-label {
        font-size: 0.78rem;
        font-weight: 700;
        color: var(--warning);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        margin-bottom: 8px;
      }
      .q-steps {
        list-style: none;
        padding: 0;
      }
      .q-steps li {
        padding: 6px 0;
        border-bottom: 1px dashed #fde68a;
        color: #78350f;
        font-size: 0.88rem;
        line-height: 1.7;
      }
      .q-steps li:last-child {
        border-bottom: none;
      }

      /* JSON panel */
      .json-panel {
        display: none;
        margin: 0 16px 16px;
        background: #0f172a;
        border-radius: 10px;
        overflow: hidden;
      }
      .json-panel.visible {
        display: block;
      }
      .json-panel pre {
        padding: 20px;
        color: #a5b4fc;
        font-family: var(--mono);
        font-size: 0.78rem;
        line-height: 1.7;
        overflow: auto;
        max-height: 400px;
      }

      /* ==================== QUESTION BANK (tab 2) ==================== */
      .bank-toolbar {
        background: var(--surface);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        padding: 20px 24px;
        margin-bottom: 20px;
      }

      .bank-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 18px;
        flex-wrap: wrap;
      }

      .stat-chip {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--bg);
        border-radius: 10px;
        font-size: 0.85rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .stat-chip strong {
        color: var(--text);
        font-weight: 700;
      }

      .bank-filters {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .filter-select {
        padding: 9px 14px;
        border: 1.5px solid var(--border);
        border-radius: 10px;
        font-family: var(--font);
        font-size: 0.85rem;
        color: var(--text);
        background: white;
        outline: none;
        cursor: pointer;
        transition: border-color var(--transition);
        min-width: 140px;
      }

      .filter-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
      }

      .filter-input {
        flex: 1;
        min-width: 180px;
        padding: 9px 14px;
        border: 1.5px solid var(--border);
        border-radius: 10px;
        font-family: var(--font);
        font-size: 0.85rem;
        color: var(--text);
        background: white;
        outline: none;
        transition: border-color var(--transition);
      }

      .filter-input::placeholder {
        color: var(--text-muted);
      }
      .filter-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
      }

      .btn-filter {
        padding: 9px 20px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 10px;
        font-family: var(--font);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition);
      }

      .btn-filter:hover {
        background: var(--primary-dark);
      }

      .btn-reset {
        padding: 9px 16px;
        background: none;
        color: var(--text-muted);
        border: 1.5px solid var(--border);
        border-radius: 10px;
        font-family: var(--font);
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition);
      }

      .btn-reset:hover {
        background: var(--bg);
        border-color: #d1d5db;
        color: var(--text-secondary);
      }

      .bank-results {
        background: var(--surface);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        overflow: hidden;
      }

      .bank-results-header {
        padding: 18px 24px;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .bank-results-count {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--text);
      }
      .bank-results-count span {
        color: var(--primary);
      }

      .bank-questions-list {
        padding: 8px 16px 16px;
      }

      .bank-empty {
        padding: 48px 24px;
        text-align: center;
        color: var(--text-muted);
      }

      .bank-empty-icon {
        font-size: 2.5rem;
        margin-bottom: 16px;
        opacity: 0.5;
      }
      .bank-empty-text {
        font-size: 0.95rem;
        font-weight: 500;
        margin-bottom: 6px;
        color: var(--text-secondary);
      }
      .bank-empty-hint {
        font-size: 0.85rem;
      }

      .bank-pagination {
        padding: 16px 24px;
        border-top: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .page-btn {
        padding: 8px 14px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: white;
        font-family: var(--font);
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all var(--transition);
      }

      .page-btn:hover:not(:disabled) {
        background: var(--bg);
        border-color: #d1d5db;
      }
      .page-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .page-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      .page-info {
        font-size: 0.82rem;
        color: var(--text-muted);
        padding: 0 8px;
      }

      /* Source exam badge */
      .q-source {
        font-size: 0.72rem;
        color: var(--text-muted);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 4px;
        margin-top: 8px;
      }

      .q-source-name {
        color: var(--text-secondary);
        font-weight: 600;
      }

      /* ==================== GENERATOR (tab 3) ==================== */
      .gen-form-card {
        background: var(--surface);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        padding: 28px 32px;
        margin-bottom: 24px;
      }

      .gen-form-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 20px;
      }

      .gen-form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
      }

      .gen-field label {
        display: block;
        font-size: 0.78rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-bottom: 6px;
      }

      .gen-field select,
      .gen-field input {
        width: 100%;
        padding: 10px 14px;
        border: 1.5px solid var(--border);
        border-radius: 10px;
        font-family: var(--font);
        font-size: 0.9rem;
        color: var(--text);
        background: white;
        outline: none;
        transition: border-color var(--transition);
      }

      .gen-field select:focus,
      .gen-field input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
      }

      .gen-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .btn-generate {
        padding: 11px 32px;
        background: linear-gradient(135deg, #7c3aed, #6d28d9);
        color: white;
        border: none;
        border-radius: 10px;
        font-family: var(--font);
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-generate:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
      }

      .btn-generate:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn-generate .spinner {
        display: none;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
      }

      .btn-generate.loading .gen-btn-text {
        display: none;
      }
      .btn-generate.loading .spinner {
        display: inline-block;
      }

      .dist-input {
        width: 100%;
        padding: 8px 12px;
        border: 1.5px solid var(--border);
        border-radius: 8px;
        font-family: var(--font);
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text);
        text-align: center;
        outline: none;
        margin-top: 6px;
        transition: border-color var(--transition);
      }
      .dist-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
      }

      .gen-hint {
        font-size: 0.82rem;
        color: var(--text-muted);
        font-weight: 400;
      }

      .gen-results {
        display: none;
        background: var(--surface);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        overflow: hidden;
      }

      .gen-results.visible {
        display: block;
        animation: fadeUp 0.4s ease;
      }

      .gen-results-header {
        padding: 18px 24px;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 12px;
      }

      .gen-results-info {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text);
      }

      .gen-results-info span {
        color: #7c3aed;
      }

      .gen-results-list {
        padding: 8px 16px 16px;
      }

      .gen-q-card {
        padding: 24px;
        border: 1px solid var(--border-light);
        border-radius: 12px;
        margin-top: 12px;
        border-left: 4px solid #7c3aed;
        transition:
          border-color var(--transition),
          box-shadow var(--transition);
      }

      .gen-q-card:hover {
        box-shadow: var(--shadow-sm);
      }

      .gen-tag {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 700;
        background: #f3e8ff;
        color: #7c3aed;
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }

      /* ==================== TOAST ==================== */
      .toast-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .toast {
        padding: 14px 20px;
        background: var(--sidebar-bg);
        color: white;
        border-radius: 12px;
        font-size: 0.88rem;
        font-weight: 500;
        box-shadow: var(--shadow-lg);
        animation: toastIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        max-width: 400px;
      }

      .toast.error {
        background: var(--error);
      }
      .toast.success {
        background: var(--success);
      }

      @keyframes toastIn {
        from {
          opacity: 0;
          transform: translateY(12px) scale(0.96);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* ==================== MOBILE ==================== */
      .mobile-bar {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 56px;
        background: var(--sidebar-bg);
        z-index: 101;
        padding: 0 16px;
        align-items: center;
        gap: 14px;
      }

      .mobile-bar .brand-icon {
        width: 32px;
        height: 32px;
        font-size: 14px;
        border-radius: 8px;
      }
      .mobile-bar .brand-name {
        color: white;
        font-size: 0.95rem;
        font-weight: 700;
        flex: 1;
      }

      .mobile-menu-btn {
        display: none;
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        padding: 8px;
      }
      .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 99;
      }

      @media (max-width: 860px) {
        .sidebar {
          transform: translateX(-100%);
          width: 280px;
        }
        .sidebar.open {
          transform: translateX(0);
          box-shadow: 4px 0 24px rgba(0, 0, 0, 0.2);
        }
        .sidebar-overlay.visible {
          display: block;
        }
        .mobile-bar {
          display: flex;
        }
        .main {
          margin-left: 0;
          padding-top: 56px;
        }
        .main-header {
          padding: 0 20px;
        }
        .main-body {
          padding: 20px;
        }
        .upload-dropzone {
          padding: 32px 20px;
        }
        .upload-controls {
          padding: 14px 16px;
        }
        .bank-filters {
          flex-direction: column;
        }
        .filter-select,
        .filter-input {
          width: 100%;
          min-width: unset;
        }
      }

      /* ==================== EXPORT DROPDOWN ==================== */
      .export-dropdown {
        position: relative;
        display: inline-block;
      }
      .export-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 600;
        font-family: var(--font);
        transition: all var(--transition);
      }
      .export-btn:hover {
        background: var(--primary-dark);
      }
      .export-btn svg {
        width: 14px;
        height: 14px;
      }
      .export-menu {
        display: none;
        position: absolute;
        right: 0;
        top: calc(100% + 4px);
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow-lg);
        min-width: 200px;
        z-index: 50;
        overflow: hidden;
        animation: fadeUp 0.15s ease;
      }
      .export-menu.visible {
        display: block;
      }
      .export-menu-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        cursor: pointer;
        font-size: 0.82rem;
        color: var(--text);
        transition: background var(--transition);
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        font-family: var(--font);
      }
      .export-menu-item:hover {
        background: var(--bg);
      }
      .export-menu-item svg {
        width: 16px;
        height: 16px;
        opacity: 0.5;
        flex-shrink: 0;
      }
      .export-menu-item .ext {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-left: auto;
      }
      .export-menu-sep {
        height: 1px;
        background: var(--border-light);
        margin: 2px 0;
      }

      /* Bank export bar */
      .bank-export-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
        border-top: 1px solid var(--border-light);
        margin-top: 8px;
      }
      .bank-export-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        font-weight: 500;
      }

      /* ==================== DASHBOARD ==================== */
      .dash-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        margin-bottom: 28px;
      }
      .stat-card {
        background: var(--surface);
        border-radius: var(--radius);
        padding: 22px 24px;
        border: 1px solid var(--border-light);
        position: relative;
        overflow: hidden;
        transition:
          transform var(--transition),
          box-shadow var(--transition);
      }
      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }
      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
      }
      .stat-card:nth-child(1)::before {
        background: linear-gradient(90deg, #6366f1, #818cf8);
      }
      .stat-card:nth-child(2)::before {
        background: linear-gradient(90deg, #f59e0b, #fbbf24);
      }
      .stat-card:nth-child(3)::before {
        background: linear-gradient(90deg, #10b981, #34d399);
      }
      .stat-card:nth-child(4)::before {
        background: linear-gradient(90deg, #f43f5e, #fb7185);
      }

      .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 14px;
        font-size: 18px;
      }
      .stat-card:nth-child(1) .stat-icon {
        background: #eef2ff;
        color: #4f46e5;
      }
      .stat-card:nth-child(2) .stat-icon {
        background: #fffbeb;
        color: #d97706;
      }
      .stat-card:nth-child(3) .stat-icon {
        background: #ecfdf5;
        color: #059669;
      }
      .stat-card:nth-child(4) .stat-icon {
        background: #fff1f2;
        color: #e11d48;
      }

      .stat-value {
        font-size: 1.9rem;
        font-weight: 800;
        letter-spacing: -0.03em;
        color: var(--text);
        line-height: 1;
        margin-bottom: 4px;
      }
      .stat-label {
        font-size: 0.82rem;
        color: var(--text-muted);
        font-weight: 500;
      }
      .stat-badge {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        font-size: 0.72rem;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 20px;
        margin-top: 8px;
      }
      .stat-badge.up {
        background: #ecfdf5;
        color: #059669;
      }
      .stat-badge.down {
        background: #fff1f2;
        color: #e11d48;
      }
      .stat-badge.neutral {
        background: #f3f4f6;
        color: #6b7280;
      }

      .dash-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 16px;
      }
      .dash-card {
        background: var(--surface);
        border-radius: var(--radius);
        border: 1px solid var(--border-light);
        padding: 20px 24px;
        min-height: 280px;
      }
      .dash-card-title {
        font-size: 0.88rem;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .dash-card-title svg {
        opacity: 0.5;
      }
      .chart-container {
        position: relative;
        height: 220px;
      }

      .activity-list {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .activity-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: var(--radius-sm);
        transition: background var(--transition);
        cursor: default;
      }
      .activity-item:hover {
        background: var(--bg);
      }
      .activity-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      .activity-dot.completed {
        background: #10b981;
      }
      .activity-dot.processing {
        background: #f59e0b;
      }
      .activity-dot.failed {
        background: #ef4444;
      }
      .activity-dot.pending {
        background: #9ca3af;
      }
      .activity-info {
        flex: 1;
        min-width: 0;
      }
      .activity-name {
        font-size: 0.84rem;
        font-weight: 600;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .activity-meta {
        font-size: 0.75rem;
        color: var(--text-muted);
      }
      .activity-count {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 2px 8px;
        background: var(--primary-light);
        color: var(--primary);
        border-radius: 12px;
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        color: var(--text-muted);
        text-align: center;
      }
      .empty-state svg {
        opacity: 0.3;
        margin-bottom: 12px;
      }
      .empty-state p {
        font-size: 0.85rem;
      }

      .quick-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 8px;
      }
      .quick-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--text);
        transition: all var(--transition);
        font-family: var(--font);
      }
      .quick-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: var(--primary-light);
      }
      .quick-btn svg {
        opacity: 0.5;
      }

      @media (max-width: 860px) {
        .dash-row {
          grid-template-columns: 1fr;
        }
        .dash-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .quick-actions {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 480px) {
        .dash-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Mobile bar -->
    <div class="mobile-bar">
      <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <svg
          width="22"
          height="22"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M3 6h18M3 12h18M3 18h18" />
        </svg>
      </button>
      <div class="brand-icon">∑</div>
      <div class="brand-name">Math Parser</div>
    </div>
    <div
      class="sidebar-overlay"
      id="sidebarOverlay"
      onclick="toggleSidebar()"
    ></div>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <div class="brand-icon">∑</div>
          <div class="brand-name">Math Parser</div>
        </div>
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">?</div>
          <div class="user-name" id="userName">Đang tải...</div>
        </div>
      </div>
      <div class="sidebar-section-label">Lịch sử phân tích</div>
      <div class="history-list" id="historyList">
        <div class="history-empty">Chưa có bài phân tích nào</div>
      </div>
      <div class="sidebar-footer">
        <button class="logout-btn" onclick="logout()">
          <svg
            width="16"
            height="16"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M9 3H5a2 2 0 00-2 2v6a2 2 0 002 2h4M12 7l3 3-3 3M7 10h8" />
          </svg>
          Đăng xuất
        </button>
      </div>
    </nav>

    <!-- Main -->
    <main class="main">
      <div class="main-header">
        <div class="tabs">
          <button
            class="tab-btn active"
            data-tab="dashboard"
            onclick="switchTab('dashboard')"
          >
            <svg
              width="16"
              height="16"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M3 9l4-4 4 4 4-4" />
              <path d="M3 5v14h18V5" />
            </svg>
            Dashboard
          </button>
          <button
            class="tab-btn"
            data-tab="upload"
            onclick="switchTab('upload')"
          >
            <svg
              width="16"
              height="16"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"
              />
            </svg>
            Upload & Parse
          </button>
          <button class="tab-btn" data-tab="bank" onclick="switchTab('bank')">
            <svg
              width="16"
              height="16"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M4 6h16M4 10h16M4 14h10" />
            </svg>
            Ngân hàng
            <span class="tab-count" id="bankCount">0</span>
          </button>
          <button
            class="tab-btn"
            data-tab="generate"
            onclick="switchTab('generate')"
          >
            <svg
              width="16"
              height="16"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M12 2L2 12l4 4L16 6zM9 5l4 4" />
            </svg>
            Sinh đề
          </button>
        </div>
      </div>

      <div class="main-body">
        <!-- ===== TAB 0: Dashboard ===== -->
        <div class="tab-panel active" id="tabDashboard">
          <!-- Stats Grid -->
          <div class="dash-grid">
            <div class="stat-card">
              <div class="stat-icon">
                <svg
                  width="20"
                  height="20"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M4 6h16M4 10h16M4 14h10" />
                </svg>
              </div>
              <div class="stat-value" id="dTotal">-</div>
              <div class="stat-label">Tổng câu hỏi</div>
              <div class="stat-badge neutral" id="dGrowth">—</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">
                <svg
                  width="20"
                  height="20"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"
                  />
                  <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" />
                </svg>
              </div>
              <div class="stat-value" id="dExams">-</div>
              <div class="stat-label">Đề đã phân tích</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">
                <svg
                  width="20"
                  height="20"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2zM22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"
                  />
                </svg>
              </div>
              <div class="stat-value" id="dTopics">-</div>
              <div class="stat-label">Chủ đề</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">
                <svg
                  width="20"
                  height="20"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M12 2L2 12l4 4L16 6zM9 5l4 4" />
                </svg>
              </div>
              <div class="stat-value" id="dNewWeek">-</div>
              <div class="stat-label">Câu mới tuần này</div>
            </div>
          </div>

          <!-- Charts Row -->
          <div class="dash-row">
            <div class="dash-card">
              <div class="dash-card-title">
                <svg
                  width="16"
                  height="16"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="10" />
                  <path d="M12 2a10 10 0 0110 10" />
                </svg>
                Phân bố độ khó
              </div>
              <div class="chart-container">
                <canvas id="chartDifficulty"></canvas>
              </div>
            </div>
            <div class="dash-card">
              <div class="dash-card-title">
                <svg
                  width="16"
                  height="16"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M18 20V10M12 20V4M6 20v-6" />
                </svg>
                Top chủ đề
              </div>
              <div class="chart-container">
                <canvas id="chartTopics"></canvas>
              </div>
            </div>
          </div>

          <!-- Bottom Row: Activity + Quick Actions -->
          <div class="dash-row">
            <div class="dash-card">
              <div class="dash-card-title">
                <svg
                  width="16"
                  height="16"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="10" />
                  <path d="M12 6v6l4 2" />
                </svg>
                Hoạt động gần đây
              </div>
              <div class="activity-list" id="activityList">
                <div class="empty-state">
                  <svg
                    width="32"
                    height="32"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                  >
                    <circle cx="16" cy="16" r="14" />
                    <path d="M16 10v6l3 3" />
                  </svg>
                  <p>Chưa có hoạt động</p>
                </div>
              </div>
            </div>
            <div class="dash-card">
              <div class="dash-card-title">
                <svg
                  width="16"
                  height="16"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z"
                  />
                  <path d="M13 2v7h7" />
                </svg>
                Thao tác nhanh
              </div>
              <div class="quick-actions">
                <button class="quick-btn" onclick="switchTab('upload')">
                  <svg
                    width="16"
                    height="16"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"
                    />
                  </svg>
                  Upload đề mới
                </button>
                <button class="quick-btn" onclick="switchTab('generate')">
                  <svg
                    width="16"
                    height="16"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M12 2L2 12l4 4L16 6zM9 5l4 4" />
                  </svg>
                  Sinh đề AI
                </button>
                <button class="quick-btn" onclick="switchTab('bank')">
                  <svg
                    width="16"
                    height="16"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M4 6h16M4 10h16M4 14h10" />
                  </svg>
                  Ngân hàng câu hỏi
                </button>
                <button class="quick-btn" onclick="switchTab('bank')">
                  <svg
                    width="16"
                    height="16"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <circle cx="11" cy="11" r="8" />
                    <path d="M21 21l-4.35-4.35" />
                  </svg>
                  Tìm kiếm câu hỏi
                </button>
              </div>

              <!-- Type breakdown -->
              <div class="dash-card-title" style="margin-top: 20px">
                <svg
                  width="16"
                  height="16"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="3" y="3" width="7" height="7" />
                  <rect x="14" y="3" width="7" height="7" />
                  <rect x="3" y="14" width="7" height="7" />
                  <rect x="14" y="14" width="7" height="7" />
                </svg>
                Loại câu hỏi
              </div>
              <div class="chart-container" style="height: 140px">
                <canvas id="chartType"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== TAB 1: Upload & Parse ===== -->
        <div class="tab-panel" id="tabUpload">
          <div class="upload-card">
            <div class="upload-dropzone" id="uploadArea">
              <div id="dropzoneDefault">
                <div class="dropzone-icon">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"
                    />
                  </svg>
                </div>
                <p class="dropzone-title">
                  Kéo thả file hoặc <span>chọn từ máy</span>
                </p>
                <p class="dropzone-subtitle">
                  PDF, DOCX, PNG, JPG, TXT — tối đa 50MB
                </p>
              </div>
              <div class="file-preview" id="filePreview">
                <div class="file-thumb" id="fileThumb">📄</div>
                <div class="file-info">
                  <div class="file-name" id="fileName"></div>
                  <div class="file-size" id="fileSize"></div>
                </div>
                <button class="file-remove" id="fileRemove" title="Xóa file">
                  <svg
                    width="18"
                    height="18"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M18 6L6 18M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <input
                type="file"
                id="fileInput"
                accept=".pdf,.docx,.doc,.png,.jpg,.jpeg,.txt,.md"
              />
            </div>
            <div class="upload-controls">
              <label class="vision-toggle">
                <input type="checkbox" id="visionMode" />
                <div class="toggle-track"></div>
                <span class="toggle-text">Vision mode</span>
              </label>
              <button class="btn-parse" id="uploadBtn" disabled>
                <span class="parse-text">Phân tích</span>
                <div class="spinner"></div>
              </button>
            </div>
          </div>

          <div class="progress-card" id="progressSection">
            <div class="progress-label">
              <div class="pulse-dot"></div>
              <span id="progressText">Đang xử lý...</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
          </div>

          <div class="results-card" id="resultsSection">
            <div class="results-toolbar">
              <div class="results-count" id="resultsCount">
                <span>0</span> câu hỏi
              </div>
              <div class="toolbar-actions">
                <button class="btn-toolbar" id="jsonToggle">JSON</button>
                <button class="btn-toolbar primary" id="downloadBtn">
                  Tải xuống
                </button>
              </div>
            </div>
            <div class="json-panel" id="jsonPanel">
              <pre id="jsonOutput"></pre>
            </div>
            <div class="questions-list" id="questionsContainer"></div>
          </div>
        </div>

        <!-- ===== TAB 2: Question Bank ===== -->
        <div class="tab-panel" id="tabBank">
          <div class="bank-toolbar">
            <div class="bank-stats" id="bankStats">
              <div class="stat-chip">
                <strong id="statTotal">0</strong> câu hỏi
              </div>
              <div class="stat-chip">
                <strong id="statTypes">0</strong> dạng bài
              </div>
              <div class="stat-chip">
                <strong id="statTopics">0</strong> chủ đề
              </div>
            </div>
            <div class="bank-filters">
              <select class="filter-select" id="filterType">
                <option value="">Tất cả dạng</option>
              </select>
              <select class="filter-select" id="filterTopic">
                <option value="">Tất cả chủ đề</option>
              </select>
              <select class="filter-select" id="filterDiff">
                <option value="">Tất cả độ khó</option>
              </select>
              <input
                class="filter-input"
                type="text"
                id="filterKeyword"
                placeholder="Tìm theo nội dung câu hỏi..."
              />
              <button class="btn-filter" onclick="searchBank()">Tìm</button>
              <button class="btn-reset" onclick="resetFilters()">
                Xóa lọc
              </button>
            </div>
          </div>

          <div class="bank-results" id="bankResults">
            <div class="bank-results-header">
              <div class="bank-results-count" id="bankResultsCount">
                Kết quả: <span>0</span> câu
              </div>
              <div class="export-dropdown" id="bankExportDropdown">
                <button
                  class="export-btn"
                  onclick="toggleExportMenu('bankExportMenu')"
                  style="font-size: 0.75rem; padding: 5px 12px"
                >
                  <svg fill="none" stroke="currentColor" stroke-width="2">
                    <path
                      d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"
                    />
                  </svg>
                  Xuất ▾
                </button>
                <div class="export-menu" id="bankExportMenu">
                  <button
                    class="export-menu-item"
                    onclick="exportBankAs('pdf')"
                  >
                    <svg fill="none" stroke="currentColor" stroke-width="2">
                      <path
                        d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"
                      />
                      <path d="M14 2v6h6" />
                    </svg>
                    PDF <span class="ext">.pdf</span>
                  </button>
                  <button
                    class="export-menu-item"
                    onclick="exportBankAs('docx')"
                  >
                    <svg fill="none" stroke="currentColor" stroke-width="2">
                      <path
                        d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"
                      />
                      <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" />
                    </svg>
                    Word <span class="ext">.docx</span>
                  </button>
                  <button
                    class="export-menu-item"
                    onclick="exportBankAs('latex')"
                  >
                    <svg fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M4 7V4h16v3M9 20h6M12 4v16" />
                    </svg>
                    LaTeX <span class="ext">.tex</span>
                  </button>
                </div>
              </div>
            </div>
            <div class="bank-questions-list" id="bankQuestionsList"></div>
            <div class="bank-pagination" id="bankPagination"></div>
          </div>
        </div>

        <!-- ===== TAB 3: Generate ===== -->
        <div class="tab-panel" id="tabGenerate">
          <div class="gen-form-card">
            <div class="gen-form-title">Chế độ sinh đề</div>
            <div
              class="gen-form-grid"
              style="grid-template-columns: 1fr 1fr; margin-bottom: 16px"
            >
              <div class="gen-field">
                <label>Chế độ</label>
                <select id="genMode" onchange="toggleGenMode()">
                  <option value="single">Sinh câu hỏi (1 mức độ)</option>
                  <option value="exam">Đề kiểm tra tổng hợp</option>
                </select>
              </div>
              <div class="gen-field">
                <label>Chủ đề</label>
                <select id="genTopic">
                  <option value="">Chủ đề bất kỳ</option>
                </select>
              </div>
            </div>

            <!-- Single mode fields -->
            <div id="singleModeFields">
              <div class="gen-form-grid">
                <div class="gen-field">
                  <label>Dạng bài</label>
                  <select id="genType">
                    <option value="">Dạng bất kỳ</option>
                  </select>
                </div>
                <div class="gen-field">
                  <label>Độ khó</label>
                  <select id="genDiff">
                    <option value="">Độ khó bất kỳ</option>
                    <option value="NB">NB - Nhận biết</option>
                    <option value="TH">TH - Thông hiểu</option>
                    <option value="VD">VD - Vận dụng</option>
                    <option value="VDC">VDC - Vận dụng cao</option>
                  </select>
                </div>
                <div class="gen-field">
                  <label>Số lượng câu</label>
                  <input
                    type="number"
                    id="genCount"
                    value="5"
                    min="1"
                    max="50"
                  />
                </div>
              </div>
            </div>

            <!-- Exam mode fields -->
            <div id="examModeFields" style="display: none">
              <div class="gen-form-grid" style="grid-template-columns: 1fr">
                <div class="gen-field">
                  <label>Dạng bài</label>
                  <select id="genTypeExam">
                    <option value="">Kết hợp TN và TL</option>
                    <option value="TN">Chỉ trắc nghiệm</option>
                    <option value="TL">Chỉ tự luận</option>
                  </select>
                </div>
              </div>
              <div style="margin-top: 12px">
                <label
                  style="
                    font-size: 0.78rem;
                    font-weight: 600;
                    color: var(--text-secondary);
                    text-transform: uppercase;
                    letter-spacing: 0.03em;
                  "
                  >Phân bổ câu hỏi</label
                >
                <div
                  class="exam-dist"
                  style="
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 12px;
                    margin-top: 8px;
                  "
                >
                  <div class="dist-item">
                    <div
                      class="dist-label"
                      style="
                        font-size: 0.82rem;
                        font-weight: 600;
                        color: #16a34a;
                      "
                    >
                      NB - Nhận biết
                    </div>
                    <input
                      type="number"
                      id="distNB"
                      value="3"
                      min="0"
                      max="50"
                      class="dist-input"
                      onchange="updateExamTotal()"
                    />
                  </div>
                  <div class="dist-item">
                    <div
                      class="dist-label"
                      style="
                        font-size: 0.82rem;
                        font-weight: 600;
                        color: #2563eb;
                      "
                    >
                      TH - Thông hiểu
                    </div>
                    <input
                      type="number"
                      id="distTH"
                      value="3"
                      min="0"
                      max="50"
                      class="dist-input"
                      onchange="updateExamTotal()"
                    />
                  </div>
                  <div class="dist-item">
                    <div
                      class="dist-label"
                      style="
                        font-size: 0.82rem;
                        font-weight: 600;
                        color: #d97706;
                      "
                    >
                      VD - Vận dụng
                    </div>
                    <input
                      type="number"
                      id="distVD"
                      value="2"
                      min="0"
                      max="50"
                      class="dist-input"
                      onchange="updateExamTotal()"
                    />
                  </div>
                  <div class="dist-item">
                    <div
                      class="dist-label"
                      style="
                        font-size: 0.82rem;
                        font-weight: 600;
                        color: #dc2626;
                      "
                    >
                      VDC - Vận dụng cao
                    </div>
                    <input
                      type="number"
                      id="distVDC"
                      value="2"
                      min="0"
                      max="50"
                      class="dist-input"
                      onchange="updateExamTotal()"
                    />
                  </div>
                </div>
                <div
                  class="exam-total"
                  id="examTotal"
                  style="
                    margin-top: 10px;
                    font-size: 0.88rem;
                    font-weight: 600;
                    color: var(--text);
                  "
                >
                  Tổng: 10 câu
                </div>
              </div>
            </div>

            <div class="gen-actions" style="margin-top: 16px">
              <button class="btn-generate" id="genBtn" onclick="doGenerate()">
                <span class="gen-btn-text">Sinh đề</span>
                <div class="spinner"></div>
              </button>
              <span class="gen-hint" id="genHint"
                >AI sẽ tham khảo câu mẫu từ ngân hàng đề của bạn</span
              >
            </div>
          </div>

          <div class="gen-results" id="genResults">
            <div class="gen-results-header">
              <div class="gen-results-info" id="genResultsInfo">
                <span>0</span> cau da sinh
              </div>
              <div class="toolbar-actions">
                <button class="btn-toolbar" onclick="downloadGenerated()">
                  JSON
                </button>
                <div class="export-dropdown" id="genExportDropdown">
                  <button
                    class="export-btn"
                    onclick="toggleExportMenu('genExportMenu')"
                  >
                    <svg fill="none" stroke="currentColor" stroke-width="2">
                      <path
                        d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"
                      />
                    </svg>
                    Xuất file ▾
                  </button>
                  <div class="export-menu" id="genExportMenu">
                    <button
                      class="export-menu-item"
                      onclick="exportGenAs('pdf')"
                    >
                      <svg fill="none" stroke="currentColor" stroke-width="2">
                        <path
                          d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"
                        />
                        <path d="M14 2v6h6" />
                      </svg>
                      PDF (in chuẩn A4) <span class="ext">.pdf</span>
                    </button>
                    <button
                      class="export-menu-item"
                      onclick="exportGenAs('docx')"
                    >
                      <svg fill="none" stroke="currentColor" stroke-width="2">
                        <path
                          d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"
                        />
                        <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" />
                      </svg>
                      Word (đề + đáp án) <span class="ext">.docx</span>
                    </button>
                    <button
                      class="export-menu-item"
                      onclick="exportGenAs('docx-split')"
                    >
                      <svg fill="none" stroke="currentColor" stroke-width="2">
                        <path
                          d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"
                        />
                        <path
                          d="M15 2H9a1 1 0 00-1 1v2a1 1 0 001 1h6a1 1 0 001-1V3a1 1 0 00-1-1z"
                        />
                      </svg>
                      Word (đề riêng / đáp án riêng)
                      <span class="ext">.zip</span>
                    </button>
                    <div class="export-menu-sep"></div>
                    <button
                      class="export-menu-item"
                      onclick="exportGenAs('latex')"
                    >
                      <svg fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 7V4h16v3M9 20h6M12 4v16" />
                      </svg>
                      LaTeX <span class="ext">.tex</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="gen-results-list" id="genResultsList"></div>
          </div>
        </div>
      </div>
    </main>

    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script>
      (() => {
        /* ===== Auth ===== */
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/login";
          return;
        }
        const authHeaders = { Authorization: "Bearer " + token };

        /* ===== State ===== */
        let currentFile = null;
        let currentResults = null;
        let isProcessing = false;
        let bankPage = 1;
        const bankPageSize = 20;

        /* ===== Elements ===== */
        const $ = (id) => document.getElementById(id);

        /* ===== Init ===== */
        loadUserInfo();
        loadHistory();
        loadDashboard();

        /* ===== Tabs ===== */
        window.switchTab = function (tab) {
          document
            .querySelectorAll(".tab-btn")
            .forEach((b) =>
              b.classList.toggle("active", b.dataset.tab === tab),
            );
          document
            .querySelectorAll(".tab-panel")
            .forEach((p) => p.classList.remove("active"));
          $("tab" + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add(
            "active",
          );

          if (tab === "dashboard") loadDashboard();
          if (tab === "bank") loadBank();
          if (tab === "generate") loadGenFilters();
        };

        /* ===== User ===== */
        async function loadUserInfo() {
          try {
            const res = await fetch("/api/v1/auth/me", {
              headers: authHeaders,
            });
            if (!res.ok) throw new Error();
            const user = await res.json();
            $("userName").textContent = user.full_name;
            $("userAvatar").textContent = user.full_name
              .charAt(0)
              .toUpperCase();
          } catch {
            logout();
          }
        }

        /* ===== History ===== */
        async function loadHistory() {
          try {
            const res = await fetch("/api/v1/parser/history", {
              headers: authHeaders,
            });
            if (!res.ok) return;
            const data = await res.json();
            renderHistory(data.items || data);
          } catch (e) {
            console.error("History error", e);
          }
        }

        function renderHistory(exams) {
          const list = $("historyList");
          if (!exams.length) {
            list.innerHTML =
              '<div class="history-empty">Chưa có bài phân tích nào</div>';
            return;
          }
          list.innerHTML = exams
            .map(
              (e) => `
                <div class="history-item" onclick="window._loadExam(${e.id})" title="${esc(e.filename)}">
                    <div class="history-item-name">${esc(e.filename)}</div>
                    <div class="history-item-meta">
                        <div class="status-dot ${e.status}"></div>
                        <span class="history-item-date">${fmtDate(e.created_at)}</span>
                    </div>
                </div>
            `,
            )
            .join("");
        }

        function fmtDate(d) {
          const dt = new Date(d);
          return (
            dt.toLocaleDateString("vi-VN", {
              day: "2-digit",
              month: "2-digit",
            }) +
            " " +
            dt.toLocaleTimeString("vi-VN", {
              hour: "2-digit",
              minute: "2-digit",
            })
          );
        }

        /* ===== Dashboard ===== */
        let _charts = {};

        async function loadDashboard() {
          try {
            const [statsRes, chartsRes, actRes] = await Promise.all([
              fetch("/api/v1/dashboard", { headers: authHeaders }),
              fetch("/api/v1/dashboard/charts", { headers: authHeaders }),
              fetch("/api/v1/dashboard/activity", { headers: authHeaders }),
            ]);

            if (statsRes.ok) {
              const s = await statsRes.json();
              $("dTotal").textContent = s.total_questions.toLocaleString();
              $("dExams").textContent = s.total_exams;
              $("dTopics").textContent = s.topics_count;
              $("dNewWeek").textContent = s.new_this_week;

              const g = s.growth_percent;
              const badge = $("dGrowth");
              if (g > 0) {
                badge.className = "stat-badge up";
                badge.textContent = `↑ +${g}% so với tuần trước`;
              } else if (g < 0) {
                badge.className = "stat-badge down";
                badge.textContent = `↓ ${g}% so với tuần trước`;
              } else {
                badge.className = "stat-badge neutral";
                badge.textContent = "Tuần này";
              }
            }

            if (chartsRes.ok) {
              const c = await chartsRes.json();
              renderDifficultyChart(c.by_difficulty);
              renderTopicChart(c.by_topic);
              renderTypeChart(c.by_type);
            }

            if (actRes.ok) {
              const a = await actRes.json();
              renderActivity(a.activities);
            }
          } catch (e) {
            console.error("Dashboard error", e);
          }
        }

        function renderDifficultyChart(data) {
          const labels = ["NB", "TH", "VD", "VDC"];
          const colors = ["#60a5fa", "#34d399", "#fbbf24", "#f87171"];
          const values = labels.map((l) => data[l] || 0);
          const total = values.reduce((a, b) => a + b, 0);

          if (_charts.diff) _charts.diff.destroy();
          if (!total) return;

          _charts.diff = new Chart($("chartDifficulty"), {
            type: "doughnut",
            data: {
              labels: labels.map((l, i) => `${l} (${values[i]})`),
              datasets: [
                {
                  data: values,
                  backgroundColor: colors,
                  borderWidth: 0,
                  hoverOffset: 6,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: "65%",
              plugins: {
                legend: {
                  position: "right",
                  labels: {
                    padding: 12,
                    usePointStyle: true,
                    pointStyleWidth: 10,
                    font: { size: 12, family: "'Plus Jakarta Sans'" },
                  },
                },
              },
            },
          });
        }

        function renderTopicChart(data) {
          const entries = Object.entries(data).slice(0, 8);
          if (!entries.length) return;
          if (_charts.topic) _charts.topic.destroy();

          const gradient = [
            "#6366f1",
            "#8b5cf6",
            "#a78bfa",
            "#c4b5fd",
            "#818cf8",
            "#6366f1",
            "#4f46e5",
            "#4338ca",
          ];

          _charts.topic = new Chart($("chartTopics"), {
            type: "bar",
            data: {
              labels: entries.map((e) =>
                e[0].length > 14 ? e[0].slice(0, 12) + "…" : e[0],
              ),
              datasets: [
                {
                  data: entries.map((e) => e[1]),
                  backgroundColor: entries.map(
                    (_, i) => gradient[i % gradient.length],
                  ),
                  borderRadius: 6,
                  barThickness: 22,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              indexAxis: "y",
              plugins: { legend: { display: false } },
              scales: {
                x: {
                  grid: { display: false },
                  ticks: { font: { size: 11, family: "'Plus Jakarta Sans'" } },
                },
                y: {
                  grid: { display: false },
                  ticks: { font: { size: 11, family: "'Plus Jakarta Sans'" } },
                },
              },
            },
          });
        }

        function renderTypeChart(data) {
          const entries = Object.entries(data);
          if (!entries.length) return;
          if (_charts.type) _charts.type.destroy();

          _charts.type = new Chart($("chartType"), {
            type: "doughnut",
            data: {
              labels: entries.map((e) => `${e[0]} (${e[1]})`),
              datasets: [
                {
                  data: entries.map((e) => e[1]),
                  backgroundColor: [
                    "#6366f1",
                    "#f59e0b",
                    "#10b981",
                    "#f43f5e",
                    "#8b5cf6",
                  ],
                  borderWidth: 0,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: "60%",
              plugins: {
                legend: {
                  position: "right",
                  labels: {
                    padding: 8,
                    usePointStyle: true,
                    pointStyleWidth: 8,
                    font: { size: 11, family: "'Plus Jakarta Sans'" },
                  },
                },
              },
            },
          });
        }

        function renderActivity(activities) {
          const el = $("activityList");
          if (!activities || !activities.length) {
            el.innerHTML =
              '<div class="empty-state"><svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="16" cy="16" r="14"/><path d="M16 10v6l3 3"/></svg><p>Chưa có hoạt động</p></div>';
            return;
          }
          el.innerHTML = activities
            .slice(0, 8)
            .map(
              (a) => `
                <div class="activity-item" onclick="window._loadExam(${a.id})">
                    <div class="activity-dot ${a.status}"></div>
                    <div class="activity-info">
                        <div class="activity-name">${escHTML(a.filename)}</div>
                        <div class="activity-meta">${a.created_at ? fmtDate(a.created_at) : ""}</div>
                    </div>
                    ${a.question_count ? `<div class="activity-count">${a.question_count} câu</div>` : ""}
                </div>
            `,
            )
            .join("");
        }

        window._loadExam = async (id) => {
          try {
            const res = await fetch("/api/v1/parser/status/" + id, {
              headers: authHeaders,
            });
            if (!res.ok) return;
            const exam = await res.json();
            if (exam.status === "completed" && exam.result_json) {
              switchTab("upload");
              displayResults(JSON.parse(exam.result_json));
              $("progressSection").classList.remove("visible");
            }
            closeSidebarMobile();
          } catch (e) {
            console.error(e);
          }
        };

        window.logout = function () {
          localStorage.removeItem("token");
          window.location.href = "/login";
        };

        /* ===== Sidebar mobile ===== */
        window.toggleSidebar = function () {
          $("sidebar").classList.toggle("open");
          $("sidebarOverlay").classList.toggle("visible");
        };

        function closeSidebarMobile() {
          if (window.innerWidth <= 860) {
            $("sidebar").classList.remove("open");
            $("sidebarOverlay").classList.remove("visible");
          }
        }

        /* ===== File handling ===== */
        const fileIcons = {
          pdf: "📕",
          docx: "📘",
          doc: "📘",
          png: "🖼️",
          jpg: "🖼️",
          jpeg: "🖼️",
          txt: "📝",
          md: "📝",
        };

        $("uploadArea").addEventListener("click", (e) => {
          if (!e.target.closest(".file-remove")) $("fileInput").click();
        });
        $("uploadArea").addEventListener("dragover", (e) => {
          e.preventDefault();
          $("uploadArea").classList.add("dragover");
        });
        $("uploadArea").addEventListener("dragleave", () =>
          $("uploadArea").classList.remove("dragover"),
        );
        $("uploadArea").addEventListener("drop", (e) => {
          e.preventDefault();
          $("uploadArea").classList.remove("dragover");
          if (e.dataTransfer.files.length) setFile(e.dataTransfer.files[0]);
        });
        $("fileInput").addEventListener("change", () => {
          if ($("fileInput").files.length) setFile($("fileInput").files[0]);
        });
        $("fileRemove").addEventListener("click", (e) => {
          e.stopPropagation();
          clearFile();
        });

        const MAX_FILE_SIZE_MB = 50;
        const MAX_FILE_SIZE = MAX_FILE_SIZE_MB * 1024 * 1024;

        function setFile(file) {
          // ── Size check ──
          if (file.size > MAX_FILE_SIZE) {
            const sizeMB = (file.size / 1024 / 1024).toFixed(1);
            toast(
              `File quá lớn (${sizeMB}MB). Tối đa ${MAX_FILE_SIZE_MB}MB.`,
              "error",
            );
            return;
          }
          if (file.size === 0) {
            toast("File trống, vui lòng chọn file khác.", "error");
            return;
          }

          currentFile = file;
          const ext = file.name.split(".").pop().toLowerCase();
          $("fileThumb").textContent = fileIcons[ext] || "📄";
          $("fileName").textContent = file.name;
          $("fileSize").textContent = fmtSize(file.size);
          $("dropzoneDefault").style.display = "none";
          $("filePreview").classList.add("visible");
          $("uploadArea").classList.add("has-file");
          $("uploadBtn").disabled = false;
        }

        function clearFile() {
          currentFile = null;
          $("fileInput").value = "";
          $("dropzoneDefault").style.display = "";
          $("filePreview").classList.remove("visible");
          $("uploadArea").classList.remove("has-file");
          $("uploadBtn").disabled = true;
        }

        function fmtSize(b) {
          return b < 1024
            ? b + " B"
            : b < 1048576
              ? (b / 1024).toFixed(1) + " KB"
              : (b / 1048576).toFixed(1) + " MB";
        }

        /* ===== Upload ===== */
        $("uploadBtn").addEventListener("click", async () => {
          if (!currentFile || isProcessing) return;
          isProcessing = true;
          $("uploadBtn").classList.add("loading");
          $("uploadBtn").disabled = true;
          $("progressSection").classList.add("visible");
          $("resultsSection").classList.remove("visible");
          $("progressText").textContent = "Đang tải lên...";
          $("progressFill").style.width = "10%";

          try {
            const form = new FormData();
            form.append("file", currentFile);
            const url =
              "/api/v1/parser/parse?speed=balanced&use_vision=" +
              $("visionMode").checked;

            const res = await fetch(url, {
              method: "POST",
              body: form,
              headers: authHeaders,
            });

            if (!res.ok) {
              if (res.status === 401) {
                logout();
                return;
              }
              const err = await res.json().catch(() => ({}));
              throw new Error(err.detail || "Upload thất bại");
            }

            const { job_id } = await res.json();
            loadHistory();
            await pollStatus(job_id);
          } catch (e) {
            $("progressSection").classList.remove("visible");
            toast(e.message, "error");
          } finally {
            $("uploadBtn").classList.remove("loading");
            $("uploadBtn").disabled = !currentFile;
            isProcessing = false;
          }
        });

        async function pollStatus(jobId) {
          let tries = 0;
          while (tries < 300) {
            tries++;
            const res = await fetch("/api/v1/parser/status/" + jobId, {
              headers: authHeaders,
            });
            if (!res.ok) {
              if (res.status === 401) logout();
              throw new Error("Kiểm tra trạng thái thất bại");
            }
            const data = await res.json();

            if (data.status === "processing") {
              $("progressFill").style.width = "50%";
              $("progressText").textContent = "AI đang phân tích câu hỏi...";
            } else if (data.status === "completed") {
              $("progressFill").style.width = "100%";
              $("progressText").textContent = "Hoàn tất!";
              setTimeout(
                () => $("progressSection").classList.remove("visible"),
                600,
              );
              if (data.result_json)
                displayResults(JSON.parse(data.result_json));
              loadHistory();
              toast(
                "Phân tích hoàn tất! Câu hỏi đã lưu vào ngân hàng.",
                "success",
              );
              // Update bank count
              loadBankFilters();
              return;
            } else if (data.status === "failed") {
              $("progressSection").classList.remove("visible");
              loadHistory();
              throw new Error(data.error_message || "Phân tích thất bại");
            }
            await new Promise((r) => setTimeout(r, 2000));
          }
        }

        /* ===== Display parse results ===== */
        function displayResults(questions) {
          currentResults = questions;
          $("resultsSection").classList.add("visible");
          $("resultsCount").innerHTML =
            "<span>" + questions.length + "</span> câu hỏi";
          $("jsonOutput").textContent = JSON.stringify(questions, null, 2);
          $("questionsContainer").innerHTML = questions
            .map((q, i) => renderQCard(q, i + 1))
            .join("");
          renderMath($("questionsContainer"));
        }

        /* ===== Shared Q-card renderer ===== */
        function renderQCard(q, num, showSource) {
          const text = q.question_text || q.question || "";
          const type = q.question_type || q.type || "TL";
          const topic = q.topic || "Toán";
          const diff = q.difficulty || "TH";
          const ans = q.answer || "";

          let steps = q.solution_steps || [];
          if (typeof steps === "string") {
            try {
              steps = JSON.parse(steps);
            } catch {
              steps = [];
            }
          }

          return `<div class="q-card">
                <div class="q-top">
                    <span class="q-num">Câu ${num}</span>
                    <div class="q-badges">
                        <span class="q-badge type">${esc(type)}</span>
                        <span class="q-badge topic">${esc(topic)}</span>
                        <span class="q-badge diff">${esc(diff)}</span>
                    </div>
                </div>
                <div class="q-text">${esc(text)}</div>
                ${ans ? `<div class="q-answer"><div class="q-answer-label">Đáp án</div><div class="q-answer-text">${esc(ans)}</div></div>` : ""}
                ${steps.length ? `<div class="q-solution"><div class="q-solution-label">Lời giải</div><ul class="q-steps">${steps.map((s) => "<li>" + esc(s) + "</li>").join("")}</ul></div>` : ""}
                ${showSource ? `<div class="q-source">Nguồn: <span class="q-source-name">${esc(showSource)}</span></div>` : ""}
            </div>`;
        }

        function esc(t) {
          if (!t) return "";
          return t
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\\n/g, "<br>")
            .replace(/\n/g, "<br>");
        }

        function renderMath(el) {
          if (typeof renderMathInElement === "function") {
            renderMathInElement(el, {
              delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true },
              ],
              throwOnError: false,
            });
          }
        }

        /* ===== Parse tab toolbar ===== */
        $("jsonToggle").addEventListener("click", () =>
          $("jsonPanel").classList.toggle("visible"),
        );
        $("downloadBtn").addEventListener("click", () => {
          if (!currentResults) return;
          const blob = new Blob([JSON.stringify(currentResults, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "math_questions_" + Date.now() + ".json";
          a.click();
          URL.revokeObjectURL(url);
        });

        /* =============================================================
           QUESTION BANK (Tab 2)
           ============================================================= */

        async function loadBank() {
          await loadBankFilters();
          await loadBankQuestions();
        }

        async function loadBankFilters() {
          try {
            const res = await fetch("/api/v1/questions/filters", {
              headers: authHeaders,
            });
            if (!res.ok) return;
            const f = await res.json();

            // Update tab count
            $("bankCount").textContent = f.total_questions;

            // Stats
            $("statTotal").textContent = f.total_questions;
            $("statTypes").textContent = f.types.length;
            $("statTopics").textContent = f.topics.length;

            // Populate dropdowns (preserve current selection)
            populateSelect($("filterType"), f.types, "Tất cả dạng");
            populateSelect($("filterTopic"), f.topics, "Tất cả chủ đề");
            populateSelect($("filterDiff"), f.difficulties, "Tất cả độ khó");
          } catch (e) {
            console.error("Bank filters error", e);
          }
        }

        function populateSelect(el, values, placeholder) {
          const current = el.value;
          el.innerHTML =
            `<option value="">${placeholder}</option>` +
            values
              .map(
                (v) =>
                  `<option value="${esc(v)}" ${v === current ? "selected" : ""}>${esc(v)}</option>`,
              )
              .join("");
        }

        async function loadBankQuestions() {
          const params = new URLSearchParams();
          params.set("page", bankPage);
          params.set("page_size", bankPageSize);

          const type = $("filterType").value;
          const topic = $("filterTopic").value;
          const diff = $("filterDiff").value;
          const keyword = $("filterKeyword").value.trim();

          if (type) params.set("type", type);
          if (topic) params.set("topic", topic);
          if (diff) params.set("difficulty", diff);
          if (keyword) params.set("keyword", keyword);

          try {
            const res = await fetch("/api/v1/questions?" + params.toString(), {
              headers: authHeaders,
            });
            if (!res.ok) return;
            const data = await res.json();

            $("bankResultsCount").innerHTML =
              `Kết quả: <span>${data.total}</span> câu`;

            const list = $("bankQuestionsList");
            if (!data.items.length) {
              list.innerHTML = `
                        <div class="bank-empty">
                            <div class="bank-empty-icon">📚</div>
                            <div class="bank-empty-text">${keyword || type || topic || diff ? "Không tìm thấy câu hỏi phù hợp" : "Ngân hàng câu hỏi trống"}</div>
                            <div class="bank-empty-hint">${keyword || type || topic || diff ? "Thử thay đổi bộ lọc" : "Upload đề thi để bắt đầu tích lũy câu hỏi"}</div>
                        </div>`;
              $("bankPagination").innerHTML = "";
              return;
            }

            list.innerHTML = data.items
              .map((q, i) => {
                const num = (data.page - 1) * data.page_size + i + 1;
                return renderQCard(q, num, false);
              })
              .join("");

            renderMath(list);
            renderPagination(data.total, data.page, data.page_size);
          } catch (e) {
            console.error("Bank questions error", e);
          }
        }

        function renderPagination(total, page, pageSize) {
          const totalPages = Math.ceil(total / pageSize);
          if (totalPages <= 1) {
            $("bankPagination").innerHTML = "";
            return;
          }

          let html = "";
          html += `<button class="page-btn" ${page <= 1 ? "disabled" : ""} onclick="window._bankPage(${page - 1})">‹</button>`;

          const start = Math.max(1, page - 2);
          const end = Math.min(totalPages, page + 2);

          if (start > 1)
            html += `<button class="page-btn" onclick="window._bankPage(1)">1</button>`;
          if (start > 2) html += `<span class="page-info">...</span>`;

          for (let i = start; i <= end; i++) {
            html += `<button class="page-btn ${i === page ? "active" : ""}" onclick="window._bankPage(${i})">${i}</button>`;
          }

          if (end < totalPages - 1)
            html += `<span class="page-info">...</span>`;
          if (end < totalPages)
            html += `<button class="page-btn" onclick="window._bankPage(${totalPages})">${totalPages}</button>`;

          html += `<button class="page-btn" ${page >= totalPages ? "disabled" : ""} onclick="window._bankPage(${page + 1})">›</button>`;

          $("bankPagination").innerHTML = html;
        }

        window._bankPage = function (p) {
          bankPage = p;
          loadBankQuestions();
        };

        window.searchBank = function () {
          bankPage = 1;
          loadBankQuestions();
        };

        window.resetFilters = function () {
          $("filterType").value = "";
          $("filterTopic").value = "";
          $("filterDiff").value = "";
          $("filterKeyword").value = "";
          bankPage = 1;
          loadBankQuestions();
        };

        // ── Debounced search (Task 6) ──
        let _searchTimer = null;
        function debouncedSearch(delay) {
          clearTimeout(_searchTimer);
          _searchTimer = setTimeout(() => {
            bankPage = 1;
            loadBankQuestions();
          }, delay);
        }

        // Keyword: debounce 400ms on typing, immediate on Enter
        $("filterKeyword").addEventListener("input", () =>
          debouncedSearch(400),
        );
        $("filterKeyword").addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            clearTimeout(_searchTimer);
            searchBank();
          }
        });

        // Dropdowns: search immediately on change
        $("filterType").addEventListener("change", () => {
          bankPage = 1;
          loadBankQuestions();
        });
        $("filterTopic").addEventListener("change", () => {
          bankPage = 1;
          loadBankQuestions();
        });
        $("filterDiff").addEventListener("change", () => {
          bankPage = 1;
          loadBankQuestions();
        });

        // Load bank count on startup
        loadBankFilters();

        /* =============================================================
           GENERATOR (Tab 3)
           ============================================================= */

        let generatedResults = null;

        // Populate gen dropdowns from bank filters
        async function loadGenFilters() {
          try {
            const res = await fetch("/api/v1/questions/filters", {
              headers: authHeaders,
            });
            if (!res.ok) return;
            const f = await res.json();

            populateSelect($("genType"), f.types, "Dạng bất kỳ");
            const topicEl = $("genTopic");
            const currentTopic = topicEl.value;
            topicEl.innerHTML =
              '<option value="">Chủ đề bất kỳ</option>' +
              f.topics
                .map(
                  (t) =>
                    `<option value="${esc(t)}" ${t === currentTopic ? "selected" : ""}>${esc(t)}</option>`,
                )
                .join("");

            const hint = $("genHint");
            if (f.total_questions > 0) {
              hint.textContent = `Ngân hàng hiện có ${f.total_questions} câu — AI sẽ tham khảo để sinh câu tương tự`;
            } else {
              hint.textContent =
                "Chưa có câu mẫu. Upload đề thi trước để AI sinh câu chính xác hơn.";
            }
          } catch (e) {
            console.error("Gen filters error", e);
          }
        }

        window.toggleGenMode = function () {
          const mode = $("genMode").value;
          $("singleModeFields").style.display = mode === "single" ? "" : "none";
          $("examModeFields").style.display = mode === "exam" ? "" : "none";
        };

        window.updateExamTotal = function () {
          const nb = parseInt($("distNB").value) || 0;
          const th = parseInt($("distTH").value) || 0;
          const vd = parseInt($("distVD").value) || 0;
          const vdc = parseInt($("distVDC").value) || 0;
          $("examTotal").textContent = `Tổng: ${nb + th + vd + vdc} câu`;
        };

        window.doGenerate = async function () {
          const btn = $("genBtn");
          btn.classList.add("loading");
          btn.disabled = true;
          $("genResults").classList.remove("visible");

          const mode = $("genMode").value;

          try {
            let url, body;

            if (mode === "exam") {
              // Exam mode - mixed difficulty
              const sections = [];
              const nb = parseInt($("distNB").value) || 0;
              const th = parseInt($("distTH").value) || 0;
              const vd = parseInt($("distVD").value) || 0;
              const vdc = parseInt($("distVDC").value) || 0;
              if (nb > 0) sections.push({ difficulty: "NB", count: nb });
              if (th > 0) sections.push({ difficulty: "TH", count: th });
              if (vd > 0) sections.push({ difficulty: "VD", count: vd });
              if (vdc > 0) sections.push({ difficulty: "VDC", count: vdc });

              if (sections.length === 0) {
                throw new Error("Chưa chọn số câu nào");
              }

              url = "/api/v1/generate/exam";
              body = {
                topic: $("genTopic").value,
                question_type: $("genTypeExam").value,
                sections: sections,
              };
            } else {
              // Single mode
              url = "/api/v1/generate";
              body = {
                question_type: $("genType").value,
                topic: $("genTopic").value,
                difficulty: $("genDiff").value,
                count: parseInt($("genCount").value) || 5,
              };
            }

            const res = await fetch(url, {
              method: "POST",
              headers: { ...authHeaders, "Content-Type": "application/json" },
              body: JSON.stringify(body),
            });

            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              throw new Error(err.detail || "Sinh đề thất bại");
            }

            const data = await res.json();
            generatedResults = data.questions;
            displayGenerated(data);
            toast(`Đã sinh ${data.questions.length} câu hỏi mới!`, "success");
          } catch (e) {
            toast(e.message, "error");
          } finally {
            btn.classList.remove("loading");
            btn.disabled = false;
          }
        };

        const DIFF_LABELS = {
          NB: "Nhận biết",
          TH: "Thông hiểu",
          VD: "Vận dụng",
          VDC: "Vận dụng cao",
        };
        const DIFF_COLORS = {
          NB: "#16a34a",
          TH: "#2563eb",
          VD: "#d97706",
          VDC: "#dc2626",
        };

        function displayGenerated(data) {
          $("genResults").classList.add("visible");
          $("genResultsInfo").innerHTML =
            `<span>${data.questions.length}</span> câu đã sinh` +
            (data.sample_count > 0
              ? ` (tham khảo ${data.sample_count} câu mẫu)`
              : "");

          const list = $("genResultsList");
          const isExam = $("genMode").value === "exam";
          let html = "";

          if (isExam) {
            // Group by difficulty
            const groups = {};
            const order = ["NB", "TH", "VD", "VDC"];
            data.questions.forEach((q) => {
              const d = q.difficulty || "TH";
              if (!groups[d]) groups[d] = [];
              groups[d].push(q);
            });

            let num = 0;
            for (const diff of order) {
              if (!groups[diff] || !groups[diff].length) continue;
              const color = DIFF_COLORS[diff] || "#666";
              const label = DIFF_LABELS[diff] || diff;
              html += `<div style="margin-top:16px;padding:8px 14px;background:${color}11;border-left:4px solid ${color};border-radius:0 8px 8px 0;">
                        <span style="font-weight:700;color:${color};font-size:0.92rem;">${label}</span>
                        <span style="color:#666;font-size:0.82rem;margin-left:8px;">${groups[diff].length} câu</span>
                    </div>`;
              for (const q of groups[diff]) {
                num++;
                html += renderGenCard(q, num);
              }
            }
          } else {
            data.questions.forEach((q, i) => {
              html += renderGenCard(q, i + 1);
            });
          }

          list.innerHTML = html;
          renderMath(list);
        }

        function renderGenCard(q, num) {
          const steps = q.solution_steps || [];
          const color = DIFF_COLORS[q.difficulty] || "#7c3aed";
          return `<div class="gen-q-card" style="border-left-color:${color}">
                <div class="q-top">
                    <span class="q-num">Câu ${num}</span>
                    <div class="q-badges">
                        <span class="gen-tag">AI</span>
                        <span class="q-badge type">${esc(q.type || "")}</span>
                        <span class="q-badge diff" style="background:${color}18;color:${color}">${esc(q.difficulty || "")}</span>
                    </div>
                </div>
                <div class="q-text">${esc(q.question || "")}</div>
                ${q.answer ? `<div class="q-answer"><div class="q-answer-label">Đáp án</div><div class="q-answer-text">${esc(q.answer)}</div></div>` : ""}
                ${steps.length ? `<div class="q-solution"><div class="q-solution-label">Lời giải</div><ul class="q-steps">${steps.map((s) => "<li>" + esc(s) + "</li>").join("")}</ul></div>` : ""}
            </div>`;
        }

        window.downloadGenerated = function () {
          if (!generatedResults) return;
          const blob = new Blob([JSON.stringify(generatedResults, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "generated_questions_" + Date.now() + ".json";
          a.click();
          URL.revokeObjectURL(url);
        };

        /* ===== Export Dropdown ===== */
        window.toggleExportMenu = function (menuId) {
          const menu = $(menuId);
          const wasVisible = menu.classList.contains("visible");
          // Close all menus first
          document
            .querySelectorAll(".export-menu")
            .forEach((m) => m.classList.remove("visible"));
          if (!wasVisible) menu.classList.add("visible");
        };
        // Close on outside click
        document.addEventListener("click", (e) => {
          if (!e.target.closest(".export-dropdown")) {
            document
              .querySelectorAll(".export-menu")
              .forEach((m) => m.classList.remove("visible"));
          }
        });

        function _getGenExportPayload() {
          if (!generatedResults || !generatedResults.length) {
            toast("Chưa có câu hỏi để xuất", "error");
            return null;
          }
          const isExam = $("genMode").value === "exam";
          const topic = $("genTopic").value || "";
          const type = isExam
            ? "Kiểm tra tổng hợp"
            : $("genType")
              ? $("genType").value
              : "Toán";
          return {
            questions: generatedResults.map((q) => ({
              question: q.question || "",
              type: q.type || "TN",
              topic: q.topic || "",
              difficulty: q.difficulty || "TH",
              answer: q.answer || "",
              solution_steps: q.solution_steps || [],
            })),
            title: isExam ? "ĐỀ KIỂM TRA" : "ĐỀ THI TOÁN HỌC",
            subtitle: topic || type,
            include_answers: true,
            include_solutions: true,
            group_by_diff: isExam,
          };
        }

        window.exportGenAs = async function (format) {
          document
            .querySelectorAll(".export-menu")
            .forEach((m) => m.classList.remove("visible"));
          const payload = _getGenExportPayload();
          if (!payload) return;

          toast("Đang tạo file...", "info");

          try {
            if (format === "pdf") {
              // PDF opens in new tab for print
              const res = await fetch("/api/v1/export/pdf", {
                method: "POST",
                headers: { ...authHeaders, "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.detail || "Export failed: " + res.status);
              }
              const html = await res.text();
              const w = window.open("", "_blank");
              if (w) {
                w.document.write(html);
                w.document.close();
              } else
                toast(
                  "Trình duyệt chặn popup. Cho phép popup rồi thử lại.",
                  "error",
                );
            } else {
              // DOCX, DOCX-split, LaTeX → download file
              const res = await fetch("/api/v1/export/" + format, {
                method: "POST",
                headers: { ...authHeaders, "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.detail || "Export failed: " + res.status);
              }
              const blob = await res.blob();
              const cd = res.headers.get("Content-Disposition") || "";
              const fnMatch = cd.match(/filename="?([^"]+)"?/);
              const filename = fnMatch ? fnMatch[1] : "export_" + Date.now();
              const a = document.createElement("a");
              a.href = URL.createObjectURL(blob);
              a.download = filename;
              a.click();
              URL.revokeObjectURL(a.href);
              toast("Đã tải file " + filename, "success");
            }
          } catch (e) {
            console.error("Export error:", e);
            toast("Lỗi xuất file: " + e.message, "error");
          }
        };

        window.exportBankAs = async function (format) {
          document
            .querySelectorAll(".export-menu")
            .forEach((m) => m.classList.remove("visible"));

          // Get current bank filters
          const topic = $("filterTopic") ? $("filterTopic").value : "";
          const diff = $("filterDiff") ? $("filterDiff").value : "";
          const type = $("filterType") ? $("filterType").value : "";
          const keyword = $("filterKeyword") ? $("filterKeyword").value : "";

          const payload = {
            topic: topic,
            difficulty: diff,
            question_type: type,
            keyword: keyword,
            limit: 200,
            title: "NGÂN HÀNG CÂU HỎI",
            subtitle: topic || "Toán học",
            include_answers: true,
            include_solutions: true,
            group_by_diff: true,
          };

          toast("Đang tạo file...", "info");

          try {
            const endpoint =
              "/api/v1/export/bank/" +
              (format === "docx-split" ? "docx" : format);
            if (format === "pdf") {
              const res = await fetch(endpoint, {
                method: "POST",
                headers: { ...authHeaders, "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.detail || "Export failed");
              }
              const html = await res.text();
              const w = window.open("", "_blank");
              if (w) {
                w.document.write(html);
                w.document.close();
              } else toast("Trình duyệt chặn popup.", "error");
            } else {
              const res = await fetch(endpoint, {
                method: "POST",
                headers: { ...authHeaders, "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.detail || "Export failed");
              }
              const blob = await res.blob();
              const cd = res.headers.get("Content-Disposition") || "";
              const fnMatch = cd.match(/filename="?([^"]+)"?/);
              const filename = fnMatch ? fnMatch[1] : "bank_export";
              const a = document.createElement("a");
              a.href = URL.createObjectURL(blob);
              a.download = filename;
              a.click();
              URL.revokeObjectURL(a.href);
              toast("Đã tải file " + filename, "success");
            }
          } catch (e) {
            console.error("Bank export error:", e);
            toast(e.message || "Lỗi xuất file", "error");
          }
        };

        /* Keep old exportPDF as alias */
        window.exportPDF = function () {
          exportGenAs("pdf");
        };

        function escHTML(t) {
          if (!t) return "";
          return t
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\n/g, "<br>");
        }

        /* ===== Toast ===== */
        function toast(msg, type = "info") {
          const el = document.createElement("div");
          el.className = "toast " + type;
          el.textContent = msg;
          $("toastContainer").appendChild(el);
          setTimeout(() => {
            el.style.opacity = "0";
            el.style.transform = "translateY(8px)";
            setTimeout(() => el.remove(), 300);
          }, 4000);
        }
      })();
    </script>
  </body>
</html>
